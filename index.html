<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>AI Market Assessor — Map + Advanced Scoring</title>
<!-- Chart.js for bar chart -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Google Charts for GeoChart map -->
<script src="https://www.gstatic.com/charts/loader.js" type="text/javascript"></script>
<style>
  :root{ --accent:#2563eb; --bg:#f6fbff; --card:#ffffff; --muted:#6b7280; --success:#10b981; }
  *{box-sizing:border-box}
  body{font-family:Inter,system-ui,Segoe UI,Arial; margin:0; background:linear-gradient(180deg,var(--bg),#fff); color:#0f172a}
  .wrap{max-width:1100px;margin:24px auto;padding:20px}
  header{display:flex;gap:14px;align-items:center}
  .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#1e40af);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800}
  h1{margin:0;font-size:1.4rem}
  .panel{background:var(--card);padding:16px;border-radius:12px;margin-top:14px;box-shadow:0 8px 28px rgba(2,6,23,0.06)}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  input[type="text"]{padding:10px;border-radius:10px;border:1px solid #e6eef8;min-width:260px}
  button{background:var(--accent);color:white;border:none;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:700}
  .small{font-size:.9rem;color:var(--muted)}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:12px;margin-top:14px}
  .card{background:#fff;padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.04);border:1px solid rgba(15,23,42,0.03)}
  .factors-list{display:flex;flex-direction:column;gap:6px;margin-top:8px}
  label.toggle{display:flex;gap:8px;align-items:center;background:#f8fbff;padding:6px 10px;border-radius:999px;border:1px solid #eef6ff}
  .results{margin-top:12px}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{padding:8px;border-bottom:1px solid #eef2ff;text-align:left}
  th{background:#f1f8ff}
  .score{font-weight:800}
  #chartArea{margin-top:12px}
  #map{height:420px;width:100%;border-radius:12px;overflow:hidden;background:#eef6ff}
  .muted{color:var(--muted)}
  .editable{width:80px;padding:6px;border-radius:8px;border:1px solid #e6eef8}
  .rowcenter{display:flex;gap:8px;align-items:center}
  .note{font-size:0.9rem;color:var(--muted);margin-top:8px}
  footer{margin-top:16px;font-size:0.9rem;color:var(--muted)}
  @media (max-width:880px){ .grid{grid-template-columns:1fr; } .card{min-height:0} }
</style>
</head>
<body>
<div class="wrap">
<header>
<div class="logo">AI</div>
<div>
<h1>AI Market Assessor — Map &amp; Advanced Scoring</h1>
<div class="small">Product → category → multi-factor market potential. Edit advanced factors live.</div>
</div>
</header>
<div aria-label="controls" class="panel" role="region">
<div class="rowcenter" style="gap:12px">
<input id="product" placeholder="Type product (e.g., wireless headphones)" type="text"/>
<input id="countryList" style="min-width:380px" type="text" value="United States, Canada, India, Germany, Brazil, Japan, Nigeria, Australia"/>
<button id="assessBtn">Assess</button>
<button disabled="" id="downloadBtn" style="background:#0ea5e9">Download JSON</button>
</div>
<div class="controls">
<div class="small">Include extra factors:</div>
<label class="toggle"><input checked="" id="usePolitical" type="checkbox"/> Political Stability</label>
<label class="toggle"><input checked="" id="useImportEase" type="checkbox"/> Import Ease</label>
<label class="toggle"><input checked="" id="useUrban" type="checkbox"/> Urban %</label>
<label class="toggle"><input checked="" id="useInternet" type="checkbox"/> Internet %</label>
</div>
<div class="note">Political Stability &amp; Import Ease are editable per country after assessment (use the inline inputs). Default example values are provided to demonstrate realistic scoring. You can change them and click "Recompute" on the result row.</div>
</div>
<div class="grid">
<div class="card">
<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<strong>Results</strong>
<div class="small muted">Table and chart show normalized scores (0–100)</div>
</div>
<div class="small muted" id="status">Idle</div>
</div>
<div class="results" id="resultsBlock" style="display:none">
<table aria-live="polite" id="resultsTable">
<thead>
<tr><th>Country</th><th>Population (M)</th><th>GDP pc</th><th>Internet %</th><th>PolStab</th><th>ImportEase</th><th>Score</th><th></th></tr>
</thead>
<tbody id="resultsTbody"></tbody>
</table>
<div id="chartArea">
<canvas id="barChart" style="max-height:300px"></canvas>
</div>
</div>
<div class="note" id="noResultsNote">No results — enter a product and click Assess.</div>
</div>
<div class="card">
<strong>Map — market potential</strong>
<div class="small muted" style="margin-top:6px">Choropleth shows countries colored by score. Hover for details.</div>
<div id="map"></div>
<div style="margin-top:12px">
<strong>Legend &amp; Controls</strong>
<div class="small muted">Blue = higher potential</div>
</div>
</div>
</div>
<footer>Notes: This demo uses example/population/GDP/internet data embedded for speed. Political Stability &amp; Import Ease are editable. For production you can wire in World Bank or other APIs for live indicators.</footer>
</div>
<script>
/* ============================
   Data (example / default)
   - For real data, you can replace these with fetched indicators.
   ============================ */

/* ============================
   Live Data Integration (World Bank + REST Countries APIs)
   ============================ */

async function fetchCountryData(countryName) {
  try {
    const restRes = await fetch(`https://restcountries.com/v3.1/name/${encodeURIComponent(countryName)}?fullText=true`);
    const restData = await restRes.json();
    const country = restData[0];
    if (!country) return null;

    const iso2 = country.cca2;
    const population = Math.round(country.population / 1e6);

    const gdp = await fetchWorldBankIndicator(iso2, "NY.GDP.PCAP.CD");
    const internet = await fetchWorldBankIndicator(iso2, "IT.NET.USER.ZS");
    const urban = await fetchWorldBankIndicator(iso2, "SP.URB.TOTL.IN.ZS");
    const political = await fetchWorldBankIndicator(iso2, "PV.EST", 0.5, true);
    const importEase = await fetchWorldBankIndicator(iso2, "LP.LPI.TRAC.XQ", 0.5, true);

    return {
      name: country.name.common,
      iso: iso2,
      population,
      gdpPerCapita: gdp || 0,
      internet: internet || 0,
      urban: urban || 0,
      political: political || 0.5,
      importEase: importEase || 0.5
    };
  } catch (err) {
    console.error("Error fetching", countryName, err);
    return null;
  }
}

async function fetchWorldBankIndicator(iso, indicator, fallback = 0, normalize = false) {
  try {
    const res = await fetch(`https://api.worldbank.org/v2/country/${iso}/indicator/${indicator}?format=json`);
    const data = await res.json();
    const value = data[1]?.find(d => d.value != null)?.value;
    if (!value) return fallback;
    if (normalize) {
      if (indicator === "PV.EST") return (value + 2.5) / 5; // normalize -2.5–2.5 → 0–1
      if (indicator === "LP.LPI.TRAC.XQ") return value / 5;  // normalize 1–5 → 0–1
    }
    return value;
  } catch {
    return fallback;
  }
}

// Replace fake EXAMPLE_BASE data fetch logic
async function loadCountryData(userCountries) {
  const results = [];
  for (const c of userCountries) {
    const data = await fetchCountryData(c);
    if (data) results.push(data);
  }
  return results;
}

// const EXAMPLE_BASE = [
  { name: "United States", iso: "US", population: 331, gdpPerCapita: 74000, internet: 92, political: 0.8, importEase: 0.85, urban: 82 },
  { name: "Canada", iso: "CA", population: 38,  gdpPerCapita: 55000, internet: 91, political: 0.9, importEase: 0.88, urban: 82 },
  { name: "India", iso: "IN", population: 1410, gdpPerCapita: 2500, internet: 55, political: 0.2, importEase: 0.45, urban: 35 },
  { name: "Germany", iso: "DE", population: 83,  gdpPerCapita: 52000, internet: 90, political: 0.85, importEase: 0.9, urban: 77 },
  { name: "Brazil", iso: "BR", population: 214, gdpPerCapita: 10000, internet: 75, political: 0.3, importEase: 0.6, urban: 88 },
  { name: "Japan", iso: "JP", population: 125, gdpPerCapita: 49000, internet: 93, political: 0.9, importEase: 0.9, urban: 92 },
  { name: "Nigeria", iso: "NG", population: 223, gdpPerCapita: 2200, internet: 45, political: 0.05, importEase: 0.35, urban: 52 },
  { name: "Australia", iso: "AU", population: 26, gdpPerCapita: 62000, internet: 94, political: 0.92, importEase: 0.87, urban: 86 }
];

// Global UI refs
const productEl = document.getElementById('product');
const countriesEl = document.getElementById('countryList');
const assessBtn = document.getElementById('assessBtn');
const statusEl = document.getElementById('status');
const resultsBlock = document.getElementById('resultsBlock');
const resultsTbody = document.getElementById('resultsTbody');
const noResultsNote = document.getElementById('noResultsNote');
const mapDiv = document.getElementById('map');
const downloadBtn = document.getElementById('downloadBtn');

let currentData = []; // array of country objects in use
let barChart = null;
let geoDataForMap = null; // for google geo chart

// Chart.js bar chart setup helper
function drawBarChart(labels, values, title) {
  const ctx = document.getElementById('barChart').getContext('2d');
  if(barChart) barChart.destroy();
  barChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: title,
        data: values,
        backgroundColor: values.map(v => `rgba(37,99,235,${0.25 + 0.6*(v/100)})`),
        borderColor: '#2543d9',
        borderWidth: 1
      }]
    },
    options: {
      indexAxis: 'y',
      scales: { x: { beginAtZero:true, max:100 } },
      responsive:true,
      plugins: { legend:{display:false} }
    }
  });
}

/* ---------------------------
   Category detection & weights
   --------------------------- */
function detectCategory(name) {
  const s = (name||'').toLowerCase();
  if(!s) return 'general';
  if(/phone|charger|laptop|wireless|headphone|earbud|camera|speaker|tv|tablet/.test(s)) return 'electronics';
  if(/shirt|jean|dress|jacket|hoodie|sneaker|shoe|socks|apparel|clothing/.test(s)) return 'clothing';
  if(/protein|bar|snack|coffee|tea|beverage|food|grocery|drink/.test(s)) return 'food';
  if(/toy|game|lego|puzzle/.test(s)) return 'toys';
  return 'general';
}

// base weight profiles (sums to 1)
const WEIGHT_PROFILES = {
  electronics: { population:0.15, gdp:0.30, internet:0.30, urban:0.10, political:0.10, importEase:0.05 },
  clothing:    { population:0.30, gdp:0.20, internet:0.10, urban:0.25, political:0.05, importEase:0.10 },
  food:        { population:0.40, gdp:0.10, internet:0.05, urban:0.20, political:0.10, importEase:0.15 },
  toys:        { population:0.35, gdp:0.2,  internet:0.15, urban:0.15, political:0.05, importEase:0.1 },
  general:     { population:0.30, gdp:0.25, internet:0.15, urban:0.15, political:0.07, importEase:0.08 }
};

/* ---------------------------
   Normalization helpers
   --------------------------- */
function normSeries(arr) {
  // arr: numbers or null -> returns 0..1
  const vals = arr.filter(v => v!=null && Number.isFinite(v));
  if(vals.length===0) return arr.map(_=>0);
  const min = Math.min(...vals), max = Math.max(...vals);
  if(min === max) return arr.map(v => v==null?0:1);
  return arr.map(v => (v==null || !Number.isFinite(v))?0:((v-min)/(max-min)));
}

/* ---------------------------
   Compute composite scores
   --------------------------- */
function computeScores(data, profile, toggles) {
  // toggles: which factors are included {political, importEase, urban, internet}
  // Build arrays for normalization
  const popArr = data.map(d => d.population);
  const gdpArr = data.map(d => d.gdpPerCapita);
  const internetArr = data.map(d => d.internet);
  const urbanArr = data.map(d => d.urban);
  const polArr = data.map(d => d.political); // 0..1 scale assumed
  const impArr = data.map(d => d.importEase); // 0..1 scale assumed

  const nPop = normSeries(popArr);
  const nGdp = normSeries(gdpArr);
  const nInternet = normSeries(internetArr);
  const nUrban = normSeries(urbanArr);
  const nPol = normSeries(polArr);
  const nImp = normSeries(impArr);

  // compute each country's score
  return data.map((d, i) => {
    let s = 0;
    // apply weights only for toggled factors
    if(toggles.includePopulation) s += nPop[i] * profile.population;
    if(toggles.includeGdp) s += nGdp[i] * profile.gdp;
    if(toggles.includeInternet) s += nInternet[i] * profile.internet;
    if(toggles.includeUrban) s += nUrban[i] * profile.urban;
    if(toggles.includePolitical) s += nPol[i] * profile.political;
    if(toggles.includeImportEase) s += nImp[i] * profile.importEase;
    // If some factors are toggled off, re-normalize so sum of used weights = 1
    const usedWeightSum = (toggles.includePopulation?profile.population:0)
                        + (toggles.includeGdp?profile.gdp:0)
                        + (toggles.includeInternet?profile.internet:0)
                        + (toggles.includeUrban?profile.urban:0)
                        + (toggles.includePolitical?profile.political:0)
                        + (toggles.includeImportEase?profile.importEase:0);
    const final = usedWeightSum>0 ? (s / usedWeightSum) : 0;
    return { ...d, rawScore: final, scorePercent: Math.round(final*1000)/10 }; // one decimal
  });
}

/* ---------------------------
   Map drawing (Google GeoChart)
   --------------------------- */
google.charts.load('current', {packages:['geochart']});
let geoChart = null;
let geoDataTable = null;
google.charts.setOnLoadCallback(()=>{/* ready */});

function drawGeoMap(rows) {
  // rows: [['Country', 'Score'], ['United States', 78], ...]
  google.charts.setOnLoadCallback(() => {
    geoDataTable = google.visualization.arrayToDataTable([['Country','Score'], ...rows]);
    const options = {
      colorAxis: {colors:['#dbeafe','#1e3a8a']},
      backgroundColor: 'transparent',
      datalessRegionColor: '#f1f5f9',
      defaultColor: '#dbeafe',
      legend: 'none'
    };
    geoChart = new google.visualization.GeoChart(mapDiv);
    geoChart.draw(geoDataTable, options);
  });
}

/* ---------------------------
   UI: render results table and wire inline editing
   --------------------------- */
function renderResults(scored) {
  // show block
  resultsBlock.style.display = 'block';
  noResultsNote.style.display = 'none';
  statusEl.textContent = 'Displaying results';

  // sort descending
  scored.sort((a,b) => b.rawScore - a.rawScore);

  // fill table
  resultsTbody.innerHTML = '';
  scored.forEach((c, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><strong>${escapeHtml(c.name)}</strong></td>
      <td>${c.population.toLocaleString()}</td>
      <td>${c.gdpPerCapita.toLocaleString()}</td>
      <td>${c.internet}%</td>
      <td><input class="editable" data-field="political" data-idx="${idx}" value="${c.political}" /></td>
      <td><input class="editable" data-field="importEase" data-idx="${idx}" value="${c.importEase}" /></td>
      <td class="score">${c.scorePercent}</td>
      <td><button data-recompute="${idx}">Recompute</button></td>
    `;
    resultsTbody.appendChild(tr);
  });

  // wire editable inputs & recompute buttons
  document.querySelectorAll('.editable').forEach(input => {
    input.addEventListener('change', (ev) => {
      const v = parseFloat(ev.target.value);
      const idx = parseInt(ev.target.dataset.idx,10);
      const field = ev.target.dataset.field;
      if(Number.isFinite(v)) currentData[idx][field] = clamp01(v);
      // don't auto-recompute full run; user can click Recompute for specific row or re-run full Assess
    });
  });
  document.querySelectorAll('button[data-recompute]').forEach(btn => {
    btn.addEventListener('click', (ev) => {
      const idx = parseInt(ev.target.getAttribute('data-recompute'),10);
      // recompute scores with current data, same toggles & profile as last run
      runScoringAndRender(lastProductName, {recomputeSingle: idx});
    });
  });

  // draw bar chart
  const labels = scored.map(s => s.name);
  const values = scored.map(s => s.scorePercent);
  drawBarChart(labels, values, `Market Potential for "${escapeHtml(lastProductName)}"`);
  // draw geo map
  const rows = scored.map(s => [s.iso, s.scorePercent]); // google accepts names or ISO codes
  drawGeoMap(rows);

  // enable download
  downloadBtn.disabled = false;
  downloadBtn.onclick = () => {
    const payload = { product: lastProductName, timestamp: new Date().toISOString(), countries: scored };
    const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'market-assessment-advanced.json'; a.click(); URL.revokeObjectURL(url);
  };
}

/* ---------------------------
   Helpers & UI glue
   --------------------------- */
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }
function clamp01(v){ // clamp to 0..1
  if (Number.isFinite(v)) return Math.max(0, Math.min(1, v));
  return 0;
}

let lastProductName = '';

// main runner that computes scores and renders
async function runScoringAndRender(productName, opts={}) {
  // opts: {recomputeSingle: idx} -> recompute only if needed using currentData
  statusEl.textContent = 'Computing…';
  // parse countries input into array; match by name from EXAMPLE_BASE if possible
  const userCountries = countriesEl.value.split(',').map(s=>s.trim()).filter(Boolean);
  // Build currentData by mapping user list to example base; for mismatches, attempt best-effort fallback
  currentData = userCountries.map(cName => {
    const found = EXAMPLE_BASE.find(b => b.name.toLowerCase() === cName.toLowerCase() || b.iso.toLowerCase() === cName.toLowerCase());
    if(found) return JSON.parse(JSON.stringify(found)); // copy
    // fallback: create minimal row with blanks
    return { name: cName, iso: cName, population: 0, gdpPerCapita:0, internet:0, political:0.5, importEase:0.5, urban:0.5 };
  });

  // if recomputeSingle: user updated inputs for one row, just recompute using existing currentData
  // else: reset any missing fields to defaults if available from EXAMPLE_BASE
  currentData = currentData.map(row => {
    const base = EXAMPLE_BASE.find(b => b.name.toLowerCase() === row.name.toLowerCase() || b.iso.toLowerCase() === row.iso.toLowerCase());
    if(base){
      // copy missing numeric fields from base if zero/empty
      return {
        name: row.name,
        iso: base.iso || row.iso,
        population: row.population || base.population,
        gdpPerCapita: row.gdpPerCapita || base.gdpPerCapita,
        internet: row.internet || base.internet,
        urban: row.urban || base.urban,
        political: Number.isFinite(row.political) ? clamp01(row.political) : base.political,
        importEase: Number.isFinite(row.importEase) ? clamp01(row.importEase) : base.importEase
      };
    }
    return row;
  });

  // determine category and profile
  const category = detectCategory(productName);
  const profile = WEIGHT_PROFILES[category] || WEIGHT_PROFILES['general'];

  // toggles
  const toggles = {
    includePolitical: document.getElementById('usePolitical').checked,
    includeImportEase: document.getElementById('useImportEase').checked,
    includeUrban: document.getElementById('useUrban').checked,
    includeInternet: document.getElementById('useInternet').checked,
    includePopulation: true, // always include population and gdp
    includeGdp: true
  };

  // compute
  const scored = computeScores(currentData, profile, toggles);

  // attach iso codes if missing: try to set from EXAMPLE_BASE name
  scored.forEach(s => {
    const base = EXAMPLE_BASE.find(b => b.name.toLowerCase() === s.name.toLowerCase());
    if(base) s.iso = base.iso;
    if(!s.iso) s.iso = s.name; // google will attempt to match
  });

  // save last product
  lastProductName = productName;

  // render
  renderResults(scored);

  statusEl.textContent = `Done • Category: ${category}`;
}

/* ---------------------------
   UI events
   --------------------------- */
assessBtn.addEventListener('click', () => {
  const p = productEl.value.trim();
  if(!p){ alert('Enter a product name (e.g., "wireless headphones")'); return; }
  runScoringAndRender(p);
});

// allow pressing Enter to run
productEl.addEventListener('keydown', (e)=> { if(e.key==='Enter') assessBtn.click(); });
countriesEl.addEventListener('keydown', (e)=> { if(e.key==='Enter' && productEl.value.trim()) assessBtn.click(); });

</script>
</body>
</html>
